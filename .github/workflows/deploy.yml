name: "Deploy ModelGuard API + Frontend"

on:
  push:
    branches: [ main ]
    workflow_dispatch:

env:
  AWS_REGION: "us-east-2"

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # 1. Checkout repository
      # -----------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # -----------------------------
      # 2. Setup Python for SAM
      # -----------------------------
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      # -----------------------------
      # 3. Configure AWS credentials
      # -----------------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::378950442938:role/GitHubAction-CI-Deploy
          role-session-name: GitHub_to_AWS_via_FederatedOIDC
          aws-region: ${{ env.AWS_REGION }}

      # -----------------------------
      # 4. Install dependencies
      # -----------------------------
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install aws-sam-cli
          pip install -r requirements.txt

      # -----------------------------
      # 5. Build and deploy SAM backend
      # -----------------------------
      - name: Build SAM application
        run: sam build

      - name: Deploy SAM application
        run: sam deploy --no-confirm-changeset --parameter-overrides DeploymentRegion=${{ env.AWS_REGION }}

      # -----------------------------
      # 6. Extract stack outputs
      # -----------------------------
      - name: Extract stack outputs
        id: outputs
        run: |
          STACK_NAME=$(grep -A 10 "\[default.deploy.parameters\]" samconfig.toml | grep "stack_name" | cut -d'"' -f2 || echo "modelguard-api")

          # Cognito outputs
          USER_POOL_ID=$(aws cloudformation describe-stacks --stack-name $STACK_NAME \
            --query 'Stacks[0].Outputs[?OutputKey==`UserPoolId`].OutputValue' --output text)
          USER_POOL_CLIENT_ID=$(aws cloudformation describe-stacks --stack-name $STACK_NAME \
            --query 'Stacks[0].Outputs[?OutputKey==`UserPoolClientId`].OutputValue' --output text)
          COGNITO_DOMAIN=$(aws cloudformation describe-stacks --stack-name $STACK_NAME \
            --query 'Stacks[0].Outputs[?OutputKey==`CognitoDomain`].OutputValue' --output text)

          # Frontend bucket and CloudFront ID
          FRONTEND_BUCKET=$(aws cloudformation describe-stacks --stack-name $STACK_NAME \
            --query 'Stacks[0].Outputs[?OutputKey==`FrontendBucket`].OutputValue' --output text)
          CLOUDFRONT_DIST_ID=$(aws cloudformation describe-stacks --stack-name $STACK_NAME \
            --query 'Stacks[0].Outputs[?OutputKey==`CloudFrontDistribution`].OutputValue' --output text)

          # Export as GitHub environment variables for later steps
          echo "USER_POOL_ID=$USER_POOL_ID" >> $GITHUB_ENV
          echo "USER_POOL_CLIENT_ID=$USER_POOL_CLIENT_ID" >> $GITHUB_ENV
          echo "COGNITO_DOMAIN=$COGNITO_DOMAIN" >> $GITHUB_ENV
          echo "FRONTEND_BUCKET=$FRONTEND_BUCKET" >> $GITHUB_ENV
          echo "CLOUDFRONT_DIST_ID=$CLOUDFRONT_DIST_ID" >> $GITHUB_ENV

      # -----------------------------
      # 7. Generate frontend Cognito config
      # -----------------------------
      - name: Generate frontend Cognito config
        run: |
          # Fail if any required value is missing
          if [ -z "$USER_POOL_ID" ] || [ -z "$USER_POOL_CLIENT_ID" ] || [ -z "$COGNITO_DOMAIN" ]; then
            echo "❌ ERROR: Cognito values missing!"
            exit 1
          fi

          # Ensure target directory exists (safe even if already exists)
          mkdir -p frontend/src/auth

          # Write the config
          cat > frontend/src/auth/generated-config.ts << EOF
          // Auto-generated from CloudFormation outputs - DO NOT EDIT
          export const cognitoConfig = {
            userPoolId: "${USER_POOL_ID}",
            clientId: "${USER_POOL_CLIENT_ID}", 
            domain: "${COGNITO_DOMAIN}",
            region: "${{ env.AWS_REGION }}",
            authority: "https://cognito-idp.${{ env.AWS_REGION }}.amazonaws.com/${USER_POOL_ID}"
          }
          EOF

          echo "✅ Generated frontend Cognito config"

      # -----------------------------
      # 8. Setup Node and frontend deps
      # -----------------------------
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install frontend dependencies
        run: npm ci
        working-directory: ./frontend

      # -----------------------------
      # 9. Build frontend
      # -----------------------------
      - name: Build frontend
        run: npm run build
        working-directory: ./frontend

      # -----------------------------
      # 10. Detect changed files and sync to S3
      # -----------------------------
      - name: Detect changes and upload
        id: s3sync
        run: |
          CHANGED_FILES=$(aws s3 sync ./frontend/build s3://$FRONTEND_BUCKET --exact-timestamps --dryrun \
            | grep "upload:" \
            | awk '{print "/" $2}')

          # Upload new/changed files
          aws s3 sync ./frontend/build s3://$FRONTEND_BUCKET --exact-timestamps

          # Share changed files with next step
          echo "CHANGED_FILES=$CHANGED_FILES" >> $GITHUB_ENV

      # -----------------------------
      # 11. Invalidate CloudFront only if files changed
      # -----------------------------
      - name: CloudFront invalidation
        run: |
          if [ -n "$CHANGED_FILES" ]; then
            echo "Invalidating changed files in CloudFront..."
            aws cloudfront create-invalidation \
              --distribution-id $CLOUDFRONT_DIST_ID \
              --paths $CHANGED_FILES
          else
            echo "No frontend changes detected. Skipping CloudFront invalidation."
