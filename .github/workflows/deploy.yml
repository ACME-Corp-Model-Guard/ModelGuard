# This is a basic workflow to help you get started with Actions
name: "Deploy ModelGuard API"

# Controls when the action will run. Invokes the workflow on push events but only for the main branch
on:
  push:
    branches: [ main ]

env:
  AWS_REGION: "us-east-2"

# Permission can be added at job level or workflow level    
permissions:
  id-token: write   # This is required for requesting the JWT
  contents: read    # This is required for actions/checkout
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::378950442938:role/GitHubAction-CI-Deploy
          role-session-name: GitHub_to_AWS_via_FederatedOIDC
          aws-region: ${{ env.AWS_REGION }}
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install aws-sam-cli
          pip install -r requirements.txt
          
      - name: Build SAM application
        run: sam build
        
      - name: Deploy SAM application
        run: sam deploy --no-confirm-changeset --parameter-overrides DeploymentRegion=${{ env.AWS_REGION }}
        
      - name: Extract Cognito config from CloudFormation
        run: |
          # Get stack name from samconfig.toml or use default
          STACK_NAME=$(grep -A 10 "\[default.deploy.parameters\]" samconfig.toml | grep "stack_name" | cut -d'"' -f2 || echo "modelguard-api")
          
          # Extract Cognito values from CloudFormation outputs
          USER_POOL_ID=$(aws cloudformation describe-stacks \
            --stack-name $STACK_NAME \
            --query 'Stacks[0].Outputs[?OutputKey==`UserPoolId`].OutputValue' \
            --output text)
          
          USER_POOL_CLIENT_ID=$(aws cloudformation describe-stacks \
            --stack-name $STACK_NAME \
            --query 'Stacks[0].Outputs[?OutputKey==`UserPoolClientId`].OutputValue' \
            --output text)
          
          COGNITO_DOMAIN=$(aws cloudformation describe-stacks \
            --stack-name $STACK_NAME \
            --query 'Stacks[0].Outputs[?OutputKey==`CognitoDomain`].OutputValue' \
            --output text)
          
          # Validate that we got real values (not empty)
          if [ -z "$USER_POOL_ID" ] || [ -z "$USER_POOL_CLIENT_ID" ] || [ -z "$COGNITO_DOMAIN" ]; then
            echo "❌ ERROR: Failed to extract Cognito values from CloudFormation!"
            echo "USER_POOL_ID: '$USER_POOL_ID'"
            echo "USER_POOL_CLIENT_ID: '$USER_POOL_CLIENT_ID'"
            echo "COGNITO_DOMAIN: '$COGNITO_DOMAIN'"
            exit 1
          fi
          
          # Create generated config file
          cat > frontend/src/auth/generated-config.ts << EOF
          // Auto-generated from CloudFormation outputs - DO NOT EDIT MANUALLY
          export const cognitoConfig = {
            userPoolId: "$USER_POOL_ID",
            clientId: "$USER_POOL_CLIENT_ID", 
            domain: "$COGNITO_DOMAIN",
            region: "${{ env.AWS_REGION }}",
            authority: "https://cognito-idp.${{ env.AWS_REGION }}.amazonaws.com/$USER_POOL_ID"
          }
          EOF
          
          echo "✅ Generated Cognito config with User Pool ID: $USER_POOL_ID"
          
          # Double-check the generated file doesn't contain PLACEHOLDER
          if grep -q "PLACEHOLDER" frontend/src/auth/generated-config.ts; then
            echo "❌ ERROR: Generated config still contains PLACEHOLDER values!"
            cat frontend/src/auth/generated-config.ts
            exit 1
          fi
